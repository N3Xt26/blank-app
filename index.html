<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sage Alcohol Compass</title>
    <style>
        :root {
            --bg-color: #F9F7F2;
            --accent-color: #8FBC8F;
            --text-color: #546E7A;
            --shadow: 0 10px 30px rgba(0,0,0,0.03);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0; 
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column;
            background-color: var(--bg-color);
            font-family: -apple-system, system-ui, sans-serif;
            color: var(--text-color);
            overflow: hidden;
        }

        /* Layout Responsivo Centrale */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        header {
            padding-top: 40px;
            width: 100%;
        }

        h1 { 
            font-weight: 600; 
            font-size: clamp(1.2rem, 5vw, 1.6rem); 
            margin: 0 0 8px 0;
            padding: 0 15px;
        }

        #status { 
            font-size: 0.9rem; 
            opacity: 0.7; 
            margin: 0;
            min-height: 1.2rem;
        }

        /* Bussola Adattiva */
        #compass-outer {
            position: relative;
            width: min(80vw, 320px);
            height: min(80vw, 320px);
            background: white;
            border-radius: 50%;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: auto; /* Centra verticalmente nello spazio flex */
        }

        #arrow-svg {
            width: 60%;
            height: 60%;
            fill: var(--accent-color);
            /* Smoothing per movimenti fluidi */
            transition: transform 0.25s cubic-bezier(0.215, 0.61, 0.355, 1);
            will-change: transform;
        }

        /* Pulsanti e Feedback */
        footer {
            padding-bottom: env(safe-area-inset-bottom, 30px);
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .btn {
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s active;
        }

        .btn-ghost {
            background: transparent;
            border: 1.5px solid var(--accent-color);
            color: var(--accent-color);
            padding: 14px 35px;
            border-radius: 30px;
            font-size: 0.9rem;
        }

        #maps-btn {
            background: var(--accent-color);
            color: white;
            text-decoration: none;
            padding: 18px 50px;
            border-radius: 50px;
            box-shadow: 0 8px 20px rgba(143, 188, 143, 0.25);
            display: none; /* Appare quando il target è trovato */
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <h1 id="target-name">In attesa del segnale...</h1>
        <p id="status">Attiva GPS e Bussola per iniziare</p>
    </header>

    <main>
        <div id="compass-outer">
            <svg id="arrow-svg" viewBox="0 0 24 24">
                <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
            </svg>
        </div>
    </main>

    <footer>
        <button id="start-btn" class="btn btn-ghost">ATTIVA BUSSOLA</button>
        <a id="maps-btn" class="btn" target="_blank">APRI IN GOOGLE MAPS</a>
    </footer>

    <script>
        let userCoords = null;
        let targetBearing = null;
        let currentRotation = 0;

        const arrow = document.getElementById('arrow-svg');
        const statusText = document.getElementById('status');
        const targetText = document.getElementById('target-name');
        const startBtn = document.getElementById('start-btn');
        const mapsBtn = document.getElementById('maps-btn');

        // Geolocation on load
        window.onload = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        userCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                        searchAlcohol(userCoords.lat, userCoords.lon);
                    },
                    () => { statusText.innerText = "Attiva il GPS per localizzare i negozi."; },
                    { enableHighAccuracy: true }
                );
            }
        };

        async function searchAlcohol(lat, lon) {
            statusText.innerText = "Scansione punti vendita...";
            // Query mirata: alcolici, bar, pub, supermercati/minimarket
            const query = `[out:json];(
                node["shop"~"alcohol|beverages|wine"](around:1500,${lat},${lon});
                node["amenity"~"bar|pub|biergarten"](around:1500,${lat},${lon});
                node["shop"~"supermarket|convenience"](around:1500,${lat},${lon});
                way["shop"~"supermarket|convenience"](around:1500,${lat},${lon});
            );out center;`;
            
            try {
                const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.elements && data.elements.length > 0) {
                    const closest = getClosest(lat, lon, data.elements);
                    const tLat = closest.lat || closest.center.lat;
                    const tLon = closest.lon || closest.center.lon;
                    
                    targetBearing = calcBearing(lat, lon, tLat, tLon);
                    targetText.innerText = closest.tags.name || "Vendita Alcolici";
                    statusText.innerText = `${Math.round(closest.distance)} metri da te`;
                    
                    mapsBtn.href = `https://www.google.com/maps/search/?api=1&query=${tLat},${tLon}`;
                    // Il bottone maps appare solo dopo l'attivazione della bussola per pulizia UI
                } else {
                    targetText.innerText = "Nessun locale trovato";
                    statusText.innerText = "Nessuna rivendita di alcolici nel raggio di 1.5km.";
                }
            } catch (err) {
                statusText.innerText = "Errore di rete. Riprova più tardi.";
            }
        }

        function getClosest(lat, lon, elements) {
            return elements.map(el => {
                const eLat = el.lat || el.center.lat;
                const eLon = el.lon || el.center.lon;
                // Haversine
                const R = 6371000;
                const dLat = (eLat - lat) * Math.PI / 180;
                const dLon = (eLon - lon) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(lat * Math.PI / 180) * Math.cos(eLat * Math.PI / 180) *
                          Math.sin(dLon/2) * Math.sin(dLon/2);
                return { ...el, distance: R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) };
            }).sort((a, b) => a.distance - b.distance)[0];
        }

        function calcBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin((lon2 - lon1) * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                      Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos((lon2 - lon1) * Math.PI / 180);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }

        // Attivazione sensori e logica bussola
        startBtn.addEventListener('click', async () => {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') startTracking();
                } catch (e) { statusText.innerText = "Permesso negato."; }
            } else {
                startTracking();
            }
        });

        function startTracking() {
            window.addEventListener('deviceorientation', (e) => {
                const heading = e.webkitCompassHeading || (360 - e.alpha);
                if (!heading || targetBearing === null) return;

                const desiredAngle = (targetBearing - heading + 360) % 360;
                
                // Calcolo del percorso più breve per evitare giri a 360°
                let diff = desiredAngle - (currentRotation % 360);
                if (diff > 180) diff -= 360;
                if (diff < -180) diff += 360;

                currentRotation += diff;
                arrow.style.transform = `rotate(${currentRotation}deg)`;
            }, true);

            startBtn.classList.add('hidden');
            if (targetBearing !== null) mapsBtn.style.display = 'block';
        }
    </script>
</body>
</html>