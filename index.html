<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Alcol Finder</title>
    <style>
      :root {
        --bg-light: #fdfcfb;
        --card-white: #ffffff;
        --accent: #e07c6a;
        --text-main: #2d3436;
        --text-dim: #636e72;
        --soft-shadow:
          0 15px 35px rgba(224, 124, 106, 0.12), 0 5px 15px rgba(0, 0, 0, 0.05);
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        width: 100vw;
        display: flex;
        flex-direction: column;
        background-color: var(--bg-light);
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        color: var(--text-main);
        overflow: hidden;
      }

      header {
        padding-top: clamp(30px, 10vh, 70px);
        text-align: center;
        flex-shrink: 0;
        z-index: 10;
      }

      #app-label {
        font-size: 1rem;
        font-weight: 700;
        letter-spacing: 2.5px;
        text-transform: uppercase;
        color: var(--accent);
        margin-bottom: 8px;
      }

      h1 {
        font-weight: 700;
        font-size: clamp(1.6rem, 8vw, 2.2rem);
        margin: 0;
        padding: 0 30px;
        letter-spacing: -0.5px;
        transition: opacity 0.3s;
      }

      #status {
        font-size: 0.95rem;
        margin-top: 10px;
        color: var(--text-dim);
      }

      /* Sezione Bussola */
      .compass-section {
        flex: 2;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .compass-container {
        position: relative;
        width: min(72vw, 300px);
        height: min(72vw, 300px);
        background: var(--card-white);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--soft-shadow);
        border: 1px solid rgba(224, 124, 106, 0.1);
        /* Importante per l'effetto ottico della bottiglia che gira */
        overflow: hidden;
      }

      #bottle-img {
        /* Dimensione leggermente ridotta per permettere la rotazione senza tagliare angoli */
        width: 65%;
        height: auto;
        object-fit: contain;
        /* Rimuoviamo la transition CSS perché useremo JS per la fisica */
        will-change: transform;
        filter: drop-shadow(0 10px 10px rgba(0, 0, 0, 0.15));
      }

      /* Sezione Azione */
      .action-section {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding-bottom: env(safe-area-inset-bottom, 30px);
        flex-direction: column;
        gap: 15px;
      }

      .btn {
        font-family: inherit;
        font-weight: 600;
        border: none;
        cursor: pointer;
        width: 80%;
        max-width: 280px;
        padding: 20px;
        border-radius: 50px;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-size: 0.85rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: center;
        text-decoration: none;
      }

      #main-action-btn {
        background: var(--accent);
        color: white;
        box-shadow: 0 8px 20px rgba(224, 124, 106, 0.3);
        display: block; /* Visibile all'inizio */
      }

      #main-action-btn:active {
        transform: scale(0.95);
      }

      /* Loading Spinner integrato nel bottone */
      .spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
        display: none;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Dialog Box per Errori */
      #error-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 85%;
        max-width: 320px;
        background: white;
        padding: 30px;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        text-align: center;
        z-index: 100;
        display: none;
      }
      #error-box h3 {
        margin: 0 0 10px;
        color: var(--accent);
      }
      #error-box button {
        margin-top: 15px;
        background: var(--accent);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
      }
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 90;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="overlay" id="overlay"></div>
    <div id="error-box">
      <h3>Ops!</h3>
      <p id="error-msg">Problema tecnico.</p>
      <button onclick="resetApp()">RIPROVA</button>
    </div>

    <header>
      <div id="app-label">Alcol Finder</div>
      <h1 id="target-name">Hai sete?</h1>
      <p id="status">Premi il pulsante per cercare</p>
    </header>

    <div class="compass-section">
      <div class="compass-container">
        <img src="ago.png" id="bottle-img" alt="Bottiglia" />
      </div>
    </div>

    <div class="action-section">
      <a id="main-action-btn" class="btn" href="#">
        <span class="spinner" id="btn-spinner"></span>
        <span id="btn-text">CERCA DA BERE</span>
      </a>
    </div>

    <script>
      // --- VARIABILI DI STATO ---
      let appState = "IDLE"; // IDLE, SEARCHING, TRACKING
      let userCoords = null;
      let targetBearing = null; // Dove vogliamo andare (Nord geografico)
      let deviceHeading = 0; // Dove sta guardando il telefono
      let retryCount = 0;
      const maxRetries = 3;

      // --- VARIABILI FISICA ---
      let angle = 0; // Angolo attuale della bottiglia
      let velocity = 0; // Velocità di rotazione
      const SPIN_SPEED = -10; // Velocità durante la ricerca (negativo = antiorario)
      const FRICTION = 0.96; // Quanto frena (più basso = frena prima)
      const SPRING = 0.025; // Forza "magnetica" verso il target (più alto = scatta più veloce)

      // --- DOM ELEMENTS ---
      const bottleImg = document.getElementById("bottle-img");
      const statusText = document.getElementById("status");
      const targetText = document.getElementById("target-name");
      const mainBtn = document.getElementById("main-action-btn");
      const btnText = document.getElementById("btn-text");
      const btnSpinner = document.getElementById("btn-spinner");
      const errorBox = document.getElementById("error-box");
      const overlay = document.getElementById("overlay");

      // --- INITIALIZATION ---
      // Avviamo il loop fisico subito
      requestAnimationFrame(physicsLoop);

      mainBtn.addEventListener("click", (e) => {
        if (appState === "IDLE") {
          e.preventDefault();
          startExperience();
        }
        // Se è TRACKING, il bottone è un link <a> normale verso maps, quindi non preveniamo il default
      });

      // --- CORE LOGIC ---

      async function startExperience() {
        // 1. Richiedi permessi Sensori (iOS richiede click utente)
        if (typeof DeviceOrientationEvent.requestPermission === "function") {
          try {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission !== "granted") {
              alert("Senza bussola non posso indicarti la direzione!");
              return;
            }
          } catch (e) {
            console.error(e);
          }
        }

        // Avvia listener bussola
        window.addEventListener("deviceorientation", handleOrientation, true);

        // 2. Richiedi permessi GPS
        if (!navigator.geolocation) {
          showError("Il tuo browser non supporta il GPS.");
          return;
        }

        // Cambia stato UI
        setSearchingUI();

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            userCoords = {
              lat: pos.coords.latitude,
              lon: pos.coords.longitude,
            };
            trySearch();
          },
          (err) => {
            appState = "IDLE";
            showError("Serve il GPS per trovare i drink.");
          },
          { enableHighAccuracy: true },
        );
      }

      function setSearchingUI() {
        appState = "SEARCHING";
        // Inizia a girare veloce (imposto la velocità iniziale)
        velocity = SPIN_SPEED;

        targetText.innerText = "Analizzo la zona...";
        statusText.innerText = "La bottiglia sta cercando...";
        btnText.innerText = "RICERCA IN CORSO...";
        btnSpinner.style.display = "inline-block";
        mainBtn.style.opacity = "0.7";
        mainBtn.style.pointerEvents = "none"; // Disabilita click
      }

      async function trySearch() {
        const lat = userCoords.lat;
        const lon = userCoords.lon;
        const query = `[out:json];(node["shop"~"alcohol|beverages|wine"](around:2500,${lat},${lon});node["amenity"~"bar|pub|biergarten"](around:2500,${lat},${lon});node["shop"~"supermarket|convenience"](around:2500,${lat},${lon}););out center;`;

        try {
          const response = await fetch(
            `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`,
          );
          if (!response.ok) throw new Error("API Error");
          const data = await response.json();

          if (data.elements && data.elements.length > 0) {
            const closest = getClosest(lat, lon, data.elements);
            setupTarget(closest);
          } else {
            throw new Error("Nessun risultato");
          }
        } catch (err) {
          if (retryCount < maxRetries) {
            retryCount++;
            statusText.innerText = `Approfondisco la ricerca... (${retryCount})`;
            setTimeout(trySearch, 2000);
          } else {
            appState = "IDLE";
            showError("Nessun locale trovato o errore di connessione.");
          }
        }
      }

      function setupTarget(place) {
        const tLat = place.lat || place.center.lat;
        const tLon = place.lon || place.center.lon;

        // Calcola il bearing geografico (angolo fisso rispetto al Nord)
        targetBearing = calcBearing(userCoords.lat, userCoords.lon, tLat, tLon);

        // CAMBIO STATO -> TRACKING
        // Qui la magia: smettiamo di forzare lo spin, la fisica farà il resto
        appState = "TRACKING";

        // Aggiorna UI
        const name = place.tags.name || getCategoryName(place);
        targetText.innerText = name;
        statusText.innerText = `${Math.round(place.distance)}m di distanza`;

        // Aggiorna il bottone
        btnSpinner.style.display = "none";
        mainBtn.style.opacity = "1";
        mainBtn.style.pointerEvents = "auto";
        mainBtn.style.backgroundColor = "#82A350"; // Verde successo
        btnText.innerText = `RAGGIUNGI ${getCategoryName(place).toUpperCase()}`;

        // Imposta link Google Maps
        mainBtn.href = `https://www.google.com/maps/dir/?api=1&destination=${tLat},${tLon}&travelmode=walking`;
        mainBtn.target = "_blank";
      }

      // --- PHYSICS ENGINE ---
      function physicsLoop() {
        if (appState === "SEARCHING") {
          // Durante la ricerca, applichiamo una forza costante per girare
          // Usiamo un lerp dolce per arrivare alla velocità di crociera se partiamo da fermi
          velocity = velocity * 0.95 + SPIN_SPEED * 0.05;
        } else if (appState === "TRACKING" && targetBearing !== null) {
          // Calcola l'angolo target RELATIVO allo schermo
          // targetBearing = Angolo tra Nord Geo e Target
          // deviceHeading = Angolo tra Nord Geo e Alto del Telefono
          // desiredAngle = Dove deve puntare la bottiglia sullo schermo (0 = alto)
          let desiredAngle = targetBearing - deviceHeading;

          // Trova la differenza più breve tra angolo attuale e desiderato
          let diff = desiredAngle - angle;

          // Normalizza tra -180 e 180 per trovare la via più breve
          while (diff < -180) diff += 360;
          while (diff > 180) diff -= 360;

          // APPLICAZIONE FORZE
          // 1. Forza Molla: Più siamo lontani, più tiriamo
          const acceleration = diff * SPRING;

          // 2. Applica accelerazione alla velocità
          velocity += acceleration;

          // 3. Applica frizione (smorzamento) per evitare che oscilli all'infinito
          velocity *= FRICTION;
        } else {
          // IDLE: Frena lentamente fino a fermarsi
          velocity *= 0.9;
        }

        // Aggiorna posizione
        angle += velocity;
        bottleImg.style.transform = `rotate(${angle}deg)`;

        requestAnimationFrame(physicsLoop);
      }

      // --- UTILS ---
      function handleOrientation(e) {
        // Ottieni orientamento bussola (iOS vs Android)
        if (e.webkitCompassHeading) {
          deviceHeading = e.webkitCompassHeading;
        } else {
          deviceHeading = 360 - e.alpha;
        }
      }

      function getClosest(lat, lon, elements) {
        return elements
          .map((el) => {
            const eLat = el.lat || el.center.lat;
            const eLon = el.lon || el.center.lon;
            const d = getDist(lat, lon, eLat, eLon);
            return { ...el, distance: d };
          })
          .sort((a, b) => a.distance - b.distance)[0];
      }

      function getDist(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      function calcBearing(lat1, lon1, lat2, lon2) {
        const y =
          Math.sin(((lon2 - lon1) * Math.PI) / 180) *
          Math.cos((lat2 * Math.PI) / 180);
        const x =
          Math.cos((lat1 * Math.PI) / 180) * Math.sin((lat2 * Math.PI) / 180) -
          Math.sin((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.cos(((lon2 - lon1) * Math.PI) / 180);
        return ((Math.atan2(y, x) * 180) / Math.PI + 360) % 360;
      }

      function getCategoryName(el) {
        if (el.tags.shop === "supermarket") return "Supermercato";
        if (el.tags.amenity === "bar") return "Bar";
        if (el.tags.amenity === "pub") return "Pub";
        return "Locale";
      }

      function showError(msg) {
        document.getElementById("error-msg").innerText = msg;
        errorBox.style.display = "block";
        overlay.style.display = "block";
        btnText.innerText = "RIPROVA";
        btnSpinner.style.display = "none";
        mainBtn.style.opacity = "1";
        mainBtn.style.pointerEvents = "auto";
      }

      function resetApp() {
        window.location.reload();
      }
    </script>
  </body>
</html>
