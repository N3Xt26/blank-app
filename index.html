<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alcol Finder</title>
    <style>
        :root {
            --bg-color: #F9F7F2;
            --accent-red: #E57373;
            --text-color: #546E7A;
            --shadow: 0 10px 30px rgba(0,0,0,0.03);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0; 
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column;
            background-color: var(--bg-color);
            font-family: -apple-system, system-ui, sans-serif;
            color: var(--text-color);
            overflow: hidden;
        }

        header {
            padding-top: 20px;
            text-align: center;
        }

        #app-title {
            font-size: 0.8rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            opacity: 0.6;
            margin-bottom: 10px;
        }

        h1 { 
            font-weight: 600; 
            font-size: clamp(1.2rem, 6vw, 1.8rem); 
            margin: 0;
            padding: 0 15px;
        }

        #status { 
            font-size: 0.85rem; 
            margin-top: 5px;
            opacity: 0.7;
        }

        main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #compass-outer {
            position: relative;
            width: min(75vw, 300px);
            height: min(75vw, 300px);
            background: white;
            border-radius: 50%;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #arrow-svg {
            width: 65%;
            height: 65%;
            fill: var(--accent-red);
            /* La fluidità è gestita via JS per evitare scatti */
            will-change: transform;
        }

        footer {
            padding-bottom: env(safe-area-inset-bottom, 30px);
            display: flex;
            justify-content: center;
            padding-top: 20px;
        }

        .btn {
            font-family: inherit;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .btn-ghost {
            background: transparent;
            border: 1.5px solid var(--text-color);
            color: var(--text-color);
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        #maps-btn {
            background: #8FBC8F; /* Manteniamo il verde salvia per il tasto "Go" */
            color: white;
            text-decoration: none;
            padding: 18px 50px;
            border-radius: 50px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            display: none;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div id="app-title">Alcol Finder</div>
        <h1 id="target-name">Inizializzazione...</h1>
        <p id="status">Richiesta posizione GPS</p>
    </header>

    <main>
        <div id="compass-outer">
            <svg id="arrow-svg" viewBox="0 0 24 24">
                <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
            </svg>
        </div>
    </main>

    <footer>
        <button id="start-btn" class="btn btn-ghost">ATTIVA BUSSOLA</button>
        <a id="maps-btn" class="btn" target="_blank">APRI IN GOOGLE MAPS</a>
    </footer>

    <script>
        let userCoords = null;
        let targetBearing = null;
        
        // Variabili per smoothing
        let currentRotation = 0;
        let lerpRotation = 0;
        const lerpFactor = 0.15; // Più basso è, più è fluido (ma più lento)

        const arrow = document.getElementById('arrow-svg');
        const statusText = document.getElementById('status');
        const targetText = document.getElementById('target-name');
        const startBtn = document.getElementById('start-btn');
        const mapsBtn = document.getElementById('maps-btn');

        window.onload = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        userCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                        searchAlcohol(userCoords.lat, userCoords.lon);
                    },
                    () => { statusText.innerText = "GPS non disponibile."; },
                    { enableHighAccuracy: true }
                );
            }
        };

        async function searchAlcohol(lat, lon) {
            statusText.innerText = "Cercando il drink più vicino...";
            const query = `[out:json];(
                node["shop"~"alcohol|beverages|wine"](around:1500,${lat},${lon});
                node["amenity"~"bar|pub|biergarten"](around:1500,${lat},${lon});
                node["shop"~"supermarket|convenience"](around:1500,${lat},${lon});
                way["shop"~"supermarket|convenience"](around:1500,${lat},${lon});
            );out center;`;
            
            try {
                const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.elements && data.elements.length > 0) {
                    const closest = getClosest(lat, lon, data.elements);
                    const tLat = closest.lat || closest.center.lat;
                    const tLon = closest.lon || closest.center.lon;
                    
                    targetBearing = calcBearing(lat, lon, tLat, tLon);
                    targetText.innerText = closest.tags.name || "Punto Vendita";
                    statusText.innerText = `${Math.round(closest.distance)} metri`;
                    
                    mapsBtn.href = `https://www.google.com/maps/search/?api=1&query=${tLat},${tLon}`;
                } else {
                    targetText.innerText = "Nessun risultato";
                    statusText.innerText = "Niente alcolici entro 1.5km.";
                }
            } catch (err) {
                statusText.innerText = "Errore connessione API.";
            }
        }

        function getClosest(lat, lon, elements) {
            return elements.map(el => {
                const eLat = el.lat || el.center.lat;
                const eLon = el.lon || el.center.lon;
                const R = 6371000;
                const dLat = (eLat - lat) * Math.PI / 180;
                const dLon = (eLon - lon) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(lat*Math.PI/180)*Math.cos(eLat*Math.PI/180)*Math.sin(dLon/2)**2;
                return { ...el, distance: R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) };
            }).sort((a, b) => a.distance - b.distance)[0];
        }

        function calcBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin((lon2-lon1)*Math.PI/180) * Math.cos(lat2*Math.PI/180);
            const x = Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180) - Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos((lon2-lon1)*Math.PI/180);
            return (Math.atan2(y, x)*180/Math.PI + 360) % 360;
        }

        // Loop di animazione per fluidità totale
        function animate() {
            // Calcolo del percorso più breve
            let diff = currentRotation - lerpRotation;
            while (diff < -180) diff += 360;
            while (diff > 180) diff -= 360;
            
            lerpRotation += diff * lerpFactor;
            arrow.style.transform = `rotate(${lerpRotation}deg)`;
            
            requestAnimationFrame(animate);
        }

        startBtn.addEventListener('click', async () => {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                const permission = await DeviceOrientationEvent.requestPermission();
                if (permission === 'granted') startTracking();
            } else {
                startTracking();
            }
        });

        function startTracking() {
            window.addEventListener('deviceorientation', (e) => {
                const heading = e.webkitCompassHeading || (360 - e.alpha);
                if (heading && targetBearing !== null) {
                    currentRotation = (targetBearing - heading + 360) % 360;
                }
            }, true);

            startBtn.classList.add('hidden');
            if (targetBearing !== null) mapsBtn.style.display = 'block';
            
            // Avvia il loop di animazione fluida
            requestAnimationFrame(animate);
        }
    </script>
</body>
</html>